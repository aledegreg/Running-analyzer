<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>10K Running Stats Analyzer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --text-tertiary: #58a6ff;
            --accent: #1f6feb;
            --accent-hover: #388bfd;
            --success: #238636;
            --warning: #d29922;
            --danger: #da3633;
            --neutral: #6e7681;
            --best: #f0b72f;
            --pace-zone1: #0066cc;
            /* Blue */
            --pace-zone2: #00aa55;
            /* Green */
            --pace-zone3: #ffcc00;
            /* Yellow */
            --pace-zone4: #ff9900;
            /* Orange */
            --pace-zone5: #ff3300;
            /* Red */
            /* Light mode variables */
            --light-bg-primary: #ffffff;
            --light-bg-secondary: #f6f8fa;
            --light-bg-tertiary: #eaeef2;
            --light-text-primary: #24292f;
            --light-text-secondary: #57606a;
            --light-text-tertiary: #0969da;
            --light-accent: #0969da;
            --light-accent-hover: #1a7f37;
        }
        .light-theme {
            --bg-primary: var(--light-bg-primary);
            --bg-secondary: var(--light-bg-secondary);
            --bg-tertiary: var(--light-bg-tertiary);
            --text-primary: var(--light-text-primary);
            --text-secondary: var(--light-text-secondary);
            --text-tertiary: var(--light-text-tertiary);
            --accent: var(--light-accent);
            --accent-hover: var(--light-accent-hover);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
        }
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 1rem;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding-bottom: 2rem;
        }
        header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            padding: 0;
        }
        .header-icon svg {
            width: 80px;
            height: 80px;
            color: var(--accent);
            transition: transform 0.3s ease;
        }
        .header-icon:hover svg {
            transform: rotate(5deg) scale(1.05);
        }
        .header-text {
            flex: 1;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        h2 {
            font-size: 1.4rem;
            margin: 1.5rem 0 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
        }
        p {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .upload-section {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .file-input-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--text-secondary);
            border-radius: 8px;
            padding: 2.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .file-input-container:hover {
            border-color: var(--accent);
            background-color: rgba(31, 111, 235, 0.05);
        }
        .file-input-container svg {
            width: 48px;
            height: 48px;
            margin-bottom: 1rem;
            color: var(--accent);
            transition: all 0.3s ease;
        }
        .file-input-container:hover svg {
            transform: translateY(-3px);
        }
        .file-input-container p {
            text-align: center;
            margin-bottom: 0.5rem;
        }
        #file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        #file-list {
            margin-top: 1.5rem;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--bg-tertiary);
        }
        #file-list::-webkit-scrollbar {
            width: 6px;
        }
        #file-list::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }
        #file-list::-webkit-scrollbar-thumb {
            background-color: var(--accent);
            border-radius: 3px;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }
        .file-item:hover {
            transform: translateX(2px);
        }
        .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 1rem;
            font-size: 0.9rem;
        }
        .file-size {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-right: 1rem;
        }
        .remove-file {
            background-color: transparent;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .remove-file:hover {
            background-color: rgba(218, 54, 51, 0.2);
        }
        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: var(--accent);
            color: white;
            font-size: 1rem;
            padding: 0.85rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            margin: 1rem 0;
            width: 100%;
        }
        .button:hover {
            background-color: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(31, 111, 235, 0.2);
        }
        .button:active {
            transform: translateY(0);
        }
        .button:disabled {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .button svg {
            width: 18px;
            height: 18px;
        }
        .results-section {
            display: none;
            background-color: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .stat-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            background-color: var(--bg-tertiary);
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .stat-icon svg {
            width: 28px;
            height: 28px;
            color: var(--accent);
        }
        .stat-content {
            flex: 1;
        }
        .stat-title {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        .stat-subtext {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .pr-badge {
            display: inline-block;
            background-color: var(--success);
            color: white;
            font-size: 0.7rem;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
            max-height: 600px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--bg-tertiary);
            border-radius: 8px;
            background-color: var(--bg-tertiary);
        }
        .table-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background-color: var(--accent);
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        thead {
            position: sticky;
            top: 0;
            background-color: var(--bg-secondary);
            z-index: 2;
        }
        th,
        td {
            padding: 0.6rem 0.5rem;
            border-bottom: 1px solid var(--bg-tertiary);
            text-align: center;
        }
        th {
            color: var(--text-primary);
            font-weight: 600;
            white-space: nowrap;
            position: relative;
        }
        td {
            color: var(--text-secondary);
            white-space: nowrap;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .improved {
            color: var(--success);
            font-weight: 500;
        }
        .worse {
            color: var(--danger);
            font-weight: 500;
        }
        .unchanged {
            color: var(--neutral);
        }
        .best-ever {
            color: var(--best);
            font-weight: bold;
            position: relative;
        }
        .best-current {
            position: relative;
        }
        .best-current::after {
            content: "*";
            position: absolute;
            top: 0;
            right: 2px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .pace-zone1 {
            background-color: rgba(0, 102, 204, 0.2);
        }
        .pace-zone2 {
            background-color: rgba(0, 170, 85, 0.2);
        }
        .pace-zone3 {
            background-color: rgba(255, 204, 0, 0.2);
        }
        .pace-zone4 {
            background-color: rgba(255, 153, 0, 0.2);
        }
        .pace-zone5 {
            background-color: rgba(255, 51, 0, 0.2);
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(13, 17, 23, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(4px);
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
            margin-bottom: 1.5rem;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        .error-message {
            display: none;
            background-color: rgba(218, 54, 51, 0.2);
            color: var(--danger);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }
        .alert {
            display: none;
            background-color: rgba(210, 153, 34, 0.2);
            color: var(--warning);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }
        .success-message {
            display: none;
            background-color: rgba(35, 134, 54, 0.2);
            color: var(--success);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }
        .back-button {
            background-color: transparent;
            border: none;
            color: var(--accent);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            margin-bottom: 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .back-button:hover {
            color: var(--accent-hover);
            transform: translateX(-2px);
        }
        .back-button svg {
            width: 16px;
            height: 16px;
            transition: transform 0.2s ease;
        }
        .back-button:hover svg {
            transform: translateX(-3px);
        }
        .theme-toggle {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: all 0.3s ease;
        }
        .theme-toggle:hover {
            background-color: var(--accent-hover);
            transform: scale(1.1);
        }
        .theme-toggle svg {
            width: 20px;
            height: 20px;
        }
        #altitude-graph-container {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--bg-secondary);
            border-radius: 4px;
            width: 100%;
            height: 80px;
            margin-bottom: 3px;
            margin-top: 3px;
            padding: 0;
            overflow: hidden;
        }
        #altitude-graph {
            width: 100%;
            height: 100%;
        }
        #altitude-graph polyline {
            stroke: var(--accent);
            stroke-width: 2;
            fill: url(#altitude-gradient);
        }
        #altitude-values th {
            background-color: var(--bg-tertiary);
            height: 1rem;
            text-align: center;
            margin-bottom: 0.2rem;
            margin-top: 0;
            padding: 0.0rem;
            font-size: 0.75rem;
            font-weight: lighter;
            color: var(--text-tertiary);
        }
        .export-buttons {
            display: flex;
            gap: 0.75rem;
            margin: 1rem 0;
        }
        .export-button {
            flex: 1;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
            border-radius: 6px;
            padding: 0.5rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .export-button:hover {
            background-color: var(--accent);
            color: white;
        }
        .export-button svg {
            width: 16px;
            height: 16px;
        }
        /* ADDED: Styles for the new map visualization card */
        #map-visualization-card {
            display: none;
            background-color: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .map-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
        }
        .live-data-panel {
            flex: 0 0 180px;
            background-color: var(--bg-tertiary);
            border-radius: 10px;
            padding: 1rem;
        }
        .live-data-item {
            margin-bottom: 1.25rem;
        }
        .live-data-item:last-child {
            margin-bottom: 0;
        }
        .live-data-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        .live-data-value {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        #map {
            flex: 1;
            min-height: 400px;
            border-radius: 10px;
            background-color: var(--bg-tertiary);
        }
        .distance-slider-container {
            margin-top: 1.5rem;
        }
        #distance-slider {
            width: 100%;
            cursor: pointer;
        }
        .gradient-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        .gradient-legend-bar {
            width: 150px;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(to right, #00f, #0f0, #f00);
        }
        @media (max-width: 768px) {
            .map-container {
                flex-direction: column;
            }
            .live-data-panel {
                flex: 1 1 100%;
                display: flex;
                justify-content: space-around;
                text-align: center;
            }
        }
        /* END ADDED */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @media (max-width: 600px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            .header-icon svg {
                width: 60px;
                height: 60px;
            }
            h1 {
                font-size: 1.5rem;
            }
            .file-input-container {
                padding: 1.5rem 1rem;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .export-buttons {
                flex-direction: column;
            }
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .file-item {
            animation: slideIn 0.3s ease forwards;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin: 1rem 0;
            padding: 0.75rem;
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 0.85rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }
        .legend-best {
            background-color: var(--best);
        }
        .legend-improved {
            background-color: var(--success);
        }
        .legend-worse {
            background-color: var(--danger);
        }
        .legend-unchanged {
            background-color: var(--neutral);
        }
        .legend-zone1 {
            background-color: rgba(0, 102, 204, 0.3);
        }
        .legend-zone2 {
            background-color: rgba(0, 170, 85, 0.3);
        }
        .legend-zone3 {
            background-color: rgba(255, 204, 0, 0.3);
        }
        .legend-zone4 {
            background-color: rgba(255, 153, 0, 0.3);
        }
        .legend-zone5 {
            background-color: rgba(255, 51, 0, 0.3);
        }
        .evaluation-bad {
            color: var(--danger);
            font-weight: 500;
        }
        .evaluation-good {
            color: var(--success);
            font-weight: 500;
        }
        .evaluation-better {
            color: var(--accent);
            font-weight: 500;
        }
        .evaluation-text {
            font-size: 0.7rem;
            display: block;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-icon">
                <svg width="auto" height="80px" viewBox="0 0 2048 2048" xmlns="http://www.w3.org/2000/svg">
                    <g transform="matrix(1.57764,0,0,1.56073,-596.188,-624.059)">
                        <g transform="matrix(1.11406,0,0,1.00069,22.9476,45.7309)">
                            <g>
                                <rect x="367.328" y="927.483" width="107.433" height="390.418" transform="matrix(0.986683,0,0,1.36761,24.1383,-480.182)" fill="#FFC900" />
                                <rect x="367.328" y="927.483" width="107.433" height="390.418" transform="matrix(0.986683,0,0,2.33433,206.493,-1754.22)" fill="#0400FF" />
                                <rect x="367.328" y="927.483" width="107.433" height="390.418" transform="matrix(0.986683,0,0,1.7869,388.847,-1032.77)" fill="#FF001A" />
                                <rect x="367.328" y="927.483" width="107.433" height="390.418" transform="matrix(0.986683,0,0,1.5494,571.201,-719.767)" fill="#21FF00" />
                                <rect x="367.328" y="927.483" width="107.433" height="390.418" transform="matrix(0.986683,0,0,2.15352,753.555,-1515.93)" fill="#FF00E6" />
                                <rect x="367.328" y="927.483" width="107.433" height="390.418" transform="matrix(0.986683,0,0,1.96795,935.91,-1136.55)" fill="#00FFFF" />
                            </g>
                        </g>
                        <g transform="matrix(0.959376,0.282131,-0.282131,0.959376,364.629,-162.138)">
                            <path d="M968.035,854.735C900.604,877.499 886.286,914.13 928.609,972.474C995.252,917.019 1055.73,912.947 1110.05,960.091C1057.88,918.16 977.445,851.559 968.035,854.735Z" fill="#187AD1" stroke="#1D4EBB" stroke-width="5.57" />
                            <path d="M470.647,1258.65C460.817,1182 466.263,1107.93 491.763,1024.91C546.589,884.891 599.631,862.854 650.485,985.499C684.59,1048.36 772.12,1030.09 897.159,983.054C1071.22,832.894 1145.36,1036.67 1448.36,1160.63C1598.51,1207.93 1753.86,1182.49 1740.62,1307.8C1653.19,1343.19 1577.74,1353.11 1490.03,1368.48C1314.53,1399.23 1159.84,1366.37 1049.1,1322.2C938.437,1290.75 695.491,1294.09 514.853,1270.32L470.647,1258.65Z" fill="#0030FF" stroke="#01BBFF" stroke-width="10.93" />
                            <path d="M481.738,1236.21C650.345,1220.85 527.778,1033.68 518.057,971.958C635.475,1151.12 1005.6,1097.48 1079.47,1285.66C927.181,1121.27 576.979,1241.79 481.738,1236.21Z" fill="#007CFF" stroke="#0056FF" stroke-width="8.31" />
                            <path d="M1027,990.517L1110.05,960.091L1069.94,974.787" fill="#01035A" stroke="#2C23E0" stroke-width="15.54" />
                            <path d="M465.865,1254.85C326.968,1440.61 497.788,1475.55 841.202,1446.5C913.399,1368.16 1084.15,1450.27 1111.12,1457.35C1139.89,1464.9 1457.5,1462.13 1456.93,1460.96C1736.1,1398.83 1759.8,1345.21 1748.87,1301.9C1670.18,1324.03 1371.19,1414.02 1160.49,1355.91C1101.65,1339.68 1062.6,1312.14 879.189,1295.11C789.67,1286.8 581.455,1283 465.865,1254.85Z" fill="#DBDBDB" />
                        </g>
                    </g>
                </svg>
            </div>
            <div class="header-text">
                <h1>10K Running Performance Analyzer</h1>
                <p>
                    Upload TCX files from your 10km runs to analyze your performance metrics
                </p>
            </div>
        </header>
        <div id="upload-section" class="upload-section">
            <div class="file-input-container" id="drop-zone">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <p><strong>Drag & drop TCX files here</strong></p>
                <p>or click to browse</p>
                <input type="file" id="file-input" accept=".tcx" multiple>
            </div>
            <button id="analyze-button" class="button" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                Analyze Runs
            </button>
            <div id="file-list"></div>
            <div id="error-message" class="error-message"></div>
            <div id="file-format-alert" class="alert">
                For best results, upload runs from the same 10km course. Different courses may affect comparison accuracy.
            </div>
        </div>
        <div id="results-section" class="results-section">
            <button id="back-button" class="back-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Back to Upload
            </button>
            <h2>Performance Summary</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10" />
                            <path d="M12 6v6l4 2" />
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-title">Best Pace</div>
                        <div id="best-pace" class="stat-value">--:--</div>
                        <div id="best-pace-details" class="stat-subtext">Date: --, Kilometer: --</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10" />
                            <polyline points="12 6 12 12 16 14" />
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-title">Average Pace</div>
                        <div id="avg-pace" class="stat-value">--:--</div>
                        <div class="stat-subtext">Including all kilometers</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" />
                            <line x1="4" y1="22" x2="4" y2="15" />
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-title">Best Segment</div>
                        <div id="best-segment" class="stat-value">---</div>
                        <div id="best-segment-details" class="stat-subtext">Average pace: --:--</div>
                    </div>
                </div>
            </div>
            <div id="pr-section" style="display: none;">
                <h2>Personal Records</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-title">Fastest 5K</div>
                            <div id="best-5k" class="stat-value">--:--</div>
                            <div id="best-5k-date" class="stat-subtext">Date: --</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-title">Fastest 10K</div>
                            <div id="best-10k" class="stat-value">--:--</div>
                            <div id="best-10k-date" class="stat-subtext">Date: --</div>
                        </div>
                    </div>
                </div>
            </div>
            <h2>Session Details</h2>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color legend-improved"></div>
                    <span>Faster than previous run</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-worse"></div>
                    <span>Slower than previous run</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-unchanged"></div>
                    <span>Same pace as previous run</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-best"></div>
                    <span>Fastest kilometer pace ever (yellow)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-best-current"></div>
                    <span>Personal best at that time (*)</span>
                </div>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color legend-zone1"></div>
                    <span>Pace < 5:00/km</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-zone2"></div>
                    <span>5:00-5:29/km</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-zone3"></div>
                    <span>5:30-5:59/km</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-zone4"></div>
                    <span>6:00-6:29/km</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-zone5"></div>
                    <span>6:30+/km</span>
                </div>
            </div>
            <div class="export-buttons">
                <button id="export-csv" class="export-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <path d="M16 13H8"></path>
                        <path d="M16 17H8"></path>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    Export CSV
                </button>
            </div>
            <div class="table-container">
                <table id="sessions-table">
                    <thead>
                        <tr style="height: 1rem">
                            <th>Date</th>
                            <th>Avg<br>Pace</th>
                            <th>km 1</th>
                            <th>km 2</th>
                            <th>km 3</th>
                            <th>km 4</th>
                            <th>km 5</th>
                            <th>km 6</th>
                            <th>km 7</th>
                            <th>km 8</th>
                            <th>km 9</th>
                            <th>km 10</th>
                        </tr>
                        <tr id="altitude-header">
                            <th colspan="2" rowspan="2">Elevation gain (m)</th>
                            <th colspan="10" style="padding: 0px; background-color: var(--bg-tertiary)">
                                <div id="altitude-graph-container">
                                    <svg id="altitude-graph" viewBox="0 0 1000 80">
                                        <defs>
                                            <linearGradient id="altitude-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                                <stop offset="0%" stop-color="var(--accent)" stop-opacity="0.6" />
                                                <stop offset="75%" stop-color="var(--accent)" stop-opacity="0.0" />
                                            </linearGradient>
                                        </defs>
                                    </svg>
                                </div>
                            </th>
                        </tr>
                        <tr id="altitude-values"></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="map-visualization-card">
                <h2>Route Visualization</h2>
                <div class="map-container">
                    <div class="live-data-panel">
                        <div class="live-data-item">
                            <div class="live-data-title">Pace</div>
                            <div id="live-pace" class="live-data-value">--:--</div>
                        </div>
                        <div class="live-data-item">
                            <div class="live-data-title">Altitude</div>
                            <div id="live-altitude" class="live-data-value">-- m</div>
                        </div>
                        <div class="live-data-item">
                            <div class="live-data-title">Heart Rate</div>
                            <div id="live-hr" class="live-data-value">-- BPM</div>
                        </div>
                    </div>
                    <div id="map"></div>
                </div>
                <div class="distance-slider-container">
                    <input type="range" id="distance-slider" min="0" max="10" step="0.01" value="0">
                    <div class="gradient-legend">
                        <span>Downhill</span>
                        <div class="gradient-legend-bar"></div>
                        <span>Uphill</span>
                    </div>
                </div>
            </div>
            </div>
    </div>
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Processing your runs...</p>
    </div>
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
    </button>
    <script>
        // State variables
        let files = [];
        let sessions = [];
        let isDarkMode = true;
        // ADDED: State variables for map and interaction
        let currentMap = null;
        let distanceMarker = null;
        let lastRunTrackpoints = [];
        // DOM Elements
        const fileInput = document.getElementById('file-input');
        const fileList = document.getElementById('file-list');
        const analyzeButton = document.getElementById('analyze-button');
        const uploadSection = document.getElementById('upload-section');
        const resultsSection = document.getElementById('results-section');
        const backButton = document.getElementById('back-button');
        const loadingOverlay = document.getElementById('loading-overlay');
        const errorMessage = document.getElementById('error-message');
        const fileFormatAlert = document.getElementById('file-format-alert');
        const dropZone = document.getElementById('drop-zone');
        const themeToggle = document.getElementById('theme-toggle');
        const exportCsvButton = document.getElementById('export-csv');
        const prSection = document.getElementById('pr-section');
        // Stats elements
        const bestPaceElement = document.getElementById('best-pace');
        const bestPaceDetailsElement = document.getElementById('best-pace-details');
        const avgPaceElement = document.getElementById('avg-pace');
        const bestSegmentElement = document.getElementById('best-segment');
        const bestSegmentDetailsElement = document.getElementById('best-segment-details');
        const best5kElement = document.getElementById('best-5k');
        const best5kDateElement = document.getElementById('best-5k-date');
        const best10kElement = document.getElementById('best-10k');
        const best10kDateElement = document.getElementById('best-10k-date');
        const sessionsTableBody = document.querySelector('#sessions-table tbody');
        // ADDED: DOM Elements for map visualization
        const mapCard = document.getElementById('map-visualization-card');
        const distanceSlider = document.getElementById('distance-slider');
        const livePaceEl = document.getElementById('live-pace');
        const liveAltitudeEl = document.getElementById('live-altitude');
        const liveHrEl = document.getElementById('live-hr');
        // Initialize the application
        function initApp() {
            fileInput.addEventListener('change', handleFileSelection);
            analyzeButton.addEventListener('click', analyzeFiles);
            backButton.addEventListener('click', resetView);
            themeToggle.addEventListener('click', toggleTheme);
            exportCsvButton.addEventListener('click', exportToCsv);
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('dragleave', handleDragLeave);
            dropZone.addEventListener('drop', handleDrop);
            distanceSlider.addEventListener('input', (e) => updateMapInteraction(parseFloat(e.target.value)));
            setTimeout(() => {
                fileFormatAlert.style.display = 'block';
            }, 1000);
            initTheme();
        }
        // Theme management functions
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                isDarkMode = savedTheme === 'dark';
            } else {
                isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
            }
            applyTheme();
        }
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            applyTheme();
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        }
        function applyTheme() {
            if (isDarkMode) {
                document.documentElement.classList.remove('light-theme');
            } else {
                document.documentElement.classList.add('light-theme');
            }
        }
        // File handling functions
        function handleFileSelection(event) {
            const selectedFiles = Array.from(event.target.files);
            if (selectedFiles.length === 0) return;
            const tcxFiles = selectedFiles.filter(file => file.name.toLowerCase().endsWith('.tcx'));
            if (tcxFiles.length !== selectedFiles.length) {
                showError('Only TCX files are supported');
                return;
            }
            files = [...files, ...tcxFiles];
            renderFileList();
            analyzeButton.disabled = files.length === 0;
        }
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.style.borderColor = 'var(--accent)';
            dropZone.style.backgroundColor = 'rgba(31, 111, 235, 0.1)';
        }
        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.style.borderColor = 'var(--text-secondary)';
            dropZone.style.backgroundColor = 'transparent';
        }
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            handleDragLeave(e);
            const dt = e.dataTransfer;
            const droppedFiles = dt.files;
            if (droppedFiles.length > 0) {
                const dataTransfer = new DataTransfer();
                for (let i = 0; i < droppedFiles.length; i++) {
                    dataTransfer.items.add(droppedFiles[i]);
                }
                fileInput.files = dataTransfer.files;
                handleFileSelection({
                    target: {
                        files: fileInput.files
                    }
                });
            }
        }
        function renderFileList() {
            fileList.innerHTML = '';
            if (files.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'file-item';
                emptyMessage.textContent = 'No files selected';
                fileList.appendChild(emptyMessage);
                return;
            }
            files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                const fileName = document.createElement('div');
                fileName.className = 'file-name';
                fileName.textContent = file.name;
                const fileSize = document.createElement('div');
                fileSize.className = 'file-size';
                fileSize.textContent = formatFileSize(file.size);
                const removeButton = document.createElement('button');
                removeButton.className = 'remove-file';
                removeButton.innerHTML = '&times;';
                removeButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeFile(index);
                });
                fileItem.appendChild(fileName);
                fileItem.appendChild(fileSize);
                fileItem.appendChild(removeButton);
                fileList.appendChild(fileItem);
            });
        }
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        function removeFile(index) {
            files.splice(index, 1);
            renderFileList();
            analyzeButton.disabled = files.length === 0;
        }
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
        function showSuccess(message) {
            const successMessage = document.createElement('div');
            successMessage.className = 'success-message';
            successMessage.textContent = message;
            uploadSection.insertBefore(successMessage, fileFormatAlert);
            setTimeout(() => {
                successMessage.style.display = 'none';
                successMessage.remove();
            }, 3000);
        }
        function resetView() {
            resultsSection.style.display = 'none';
            uploadSection.style.display = 'block';
            mapCard.style.display = 'none';
            window.scrollTo(0, 0);
        }
        async function analyzeFiles() {
            if (files.length === 0) return;
            showLoading(true);
            try {
                sessions = [];
                for (const file of files) {
                    const session = await parseWorkout(file);
                    if (session) {
                        sessions.push(session);
                    }
                }
                if (sessions.length === 0) {
                    showError('No valid running data found in the files');
                    showLoading(false);
                    return;
                }
                sessions.sort((a, b) => new Date(a.date) - new Date(b.date));
                processResults();
                showResults();
                showSuccess('Analysis complete!');
            } catch (error) {
                console.error('Error analyzing files:', error);
                showError('An error occurred while processing files');
            } finally {
                showLoading(false);
            }
        }
        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }
        function showResults() {
            uploadSection.style.display = 'none';
            resultsSection.style.display = 'block';
            window.scrollTo(0, 0);
            setTimeout(() => {
                const tableContainer = document.querySelector('.table-container');
                tableContainer.scrollTop = tableContainer.scrollHeight;
                const lastSession = sessions[sessions.length - 1];
                if (lastSession && lastSession.trackpoints && lastSession.trackpoints.length > 0) {
                    lastRunTrackpoints = lastSession.trackpoints;
                    initializeInteractiveMap(lastRunTrackpoints, lastSession.avgPace);
                }
            }, 100);
        }
        async function parseWorkout(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const tcxContent = event.target.result;
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(tcxContent, "text/xml");
                        const activity = xmlDoc.querySelector('Activity');
                        if (!activity || activity.getAttribute('Sport') !== 'Running') {
                            resolve(null);
                            return;
                        }
                        const firstTrackpoint = xmlDoc.querySelector('Trackpoint');
                        const timeElement = firstTrackpoint.querySelector('Time');
                        const date = new Date(timeElement.textContent);
                        const session = {
                            id: file.name,
                            date: date,
                            formattedDate: formatDate(date),
                            laps: [],
                            totalDistance: 0,
                            totalTime: 0,
                            avgPace: 0,
                            elevationGain: 0,
                            kilometers: [],
                            heartRates: [],
                            cadences: [],
                            trackpoints: []
                        };
                        const trackpoints = Array.from(xmlDoc.querySelectorAll('Trackpoint'));
                        let lastElevation = null;
                        let lastDistance = 0;
                        let currentKm = 1;
                        let kmStartTime = null;
                        let kmStartDistance = 0;
                        let kmStartElevation = null;
                        const altitudeData = [];
                        for (let i = 0; i < trackpoints.length; i++) {
                            const tp = trackpoints[i];
                            const distanceElement = tp.querySelector('DistanceMeters');
                            if (!distanceElement) continue;
                            const distance = parseFloat(distanceElement.textContent);
                            if (distance <= lastDistance && i > 0) continue;
                            const timeElement = tp.querySelector('Time');
                            const timestamp = new Date(timeElement.textContent);
                            const posElement = tp.querySelector('Position');
                            const latElement = posElement ? posElement.querySelector('LatitudeDegrees') : null;
                            const lonElement = posElement ? posElement.querySelector('LongitudeDegrees') : null;
                            if (kmStartTime === null) {
                                kmStartTime = timestamp;
                                kmStartDistance = distance;
                                const elevationElement = tp.querySelector('AltitudeMeters');
                                if (elevationElement) {
                                    kmStartElevation = parseFloat(elevationElement.textContent);
                                }
                            }
                            const elevationElement = tp.querySelector('AltitudeMeters');
                            let elevation = null;
                            if (elevationElement) {
                                elevation = parseFloat(elevationElement.textContent);
                                if (lastElevation !== null && elevation > lastElevation) {
                                    session.elevationGain += (elevation - lastElevation);
                                }
                                lastElevation = elevation;
                            }
                            const heartRateElement = tp.querySelector('HeartRateBpm Value');
                            let heartRate = null;
                            if (heartRateElement) {
                                heartRate = parseInt(heartRateElement.textContent);
                                session.heartRates.push(heartRate);
                            }
                            if (latElement && lonElement) {
                                session.trackpoints.push({
                                    lat: parseFloat(latElement.textContent),
                                    lng: parseFloat(lonElement.textContent),
                                    altitude: elevation,
                                    distance: distance,
                                    heartRate: heartRate,
                                    time: timestamp
                                });
                            }
                            const cadenceElement = tp.querySelector('Cadence');
                            if (cadenceElement) {
                                const cadence = parseInt(cadenceElement.textContent);
                                session.cadences.push(cadence);
                            }
                            if (distance >= currentKm * 1000) {
                                const kmEndTime = timestamp;
                                const kmTime = (kmEndTime - kmStartTime) / 1000;
                                const kmPace = kmTime / 60;
                                const kmEndElevation = lastElevation;
                                const altitudeChange = kmEndElevation - kmStartElevation;
                                session.kilometers.push({
                                    km: currentKm,
                                    time: kmTime,
                                    pace: kmPace,
                                    formattedPace: formatPace(kmPace),
                                    altitudeChange: altitudeChange
                                });
                                currentKm++;
                                kmStartTime = timestamp;
                                kmStartDistance = distance;
                                kmStartElevation = lastElevation;
                            }
                            if (elevationElement) {
                                altitudeData.push({
                                    distance: distance,
                                    elevation: parseFloat(elevationElement.textContent)
                                });
                            }
                            lastDistance = distance;
                        }
                        if (lastDistance >= 9000 && currentKm === 10) {
                            const finalTrackpoint = trackpoints[trackpoints.length - 1];
                            const finalTime = new Date(finalTrackpoint.querySelector('Time').textContent);
                            const kmTime = (finalTime - kmStartTime) / 1000;
                            const partialDistance = lastDistance - kmStartDistance;
                            const kmPace = kmTime / 60 / (partialDistance / 1000);
                            const kmEndElevation = lastElevation;
                            const altitudeChange = kmEndElevation - kmStartElevation;
                            session.kilometers.push({
                                km: 10,
                                time: kmTime,
                                pace: kmPace,
                                formattedPace: formatPace(kmPace),
                                altitudeChange: altitudeChange,
                                isPartial: true
                            });
                        }
                        const finalTrackpoint = trackpoints[trackpoints.length - 1];
                        const finalTime = new Date(finalTrackpoint.querySelector('Time').textContent);
                        const initialTime = new Date(xmlDoc.querySelector('Trackpoint Time').textContent);
                        session.totalTime = (finalTime - initialTime) / 1000;
                        session.totalDistance = lastDistance;
                        if (session.totalDistance > 0) {
                            session.avgPace = (session.totalTime / 60) / (session.totalDistance / 1000);
                            session.formattedAvgPace = formatPace(session.avgPace);
                        }
                        session.elevationGain = Math.round(session.elevationGain);
                        if (session.heartRates.length > 0) {
                            session.avgHeartRate = Math.round(
                                session.heartRates.reduce((sum, hr) => sum + hr, 0) / session.heartRates.length
                            );
                        }
                        if (session.cadences.length > 0) {
                            session.avgCadence = Math.round(
                                session.cadences.reduce((sum, cad) => sum + cad, 0) / session.cadences.length
                            );
                        }
                        session.altitudeData = altitudeData;
                        resolve(session);
                    } catch (error) {
                        console.error('Error parsing TCX:', error);
                        resolve(null);
                    }
                };
                reader.onerror = () => {
                    reject(new Error('Error reading file'));
                };
                reader.readAsText(file);
            });
        }
        function processResults() {
            if (sessions.length === 0) return;
            let bestPace = {
                pace: Infinity,
                km: null,
                session: null
            };
            for (const session of sessions) {
                for (const km of session.kilometers) {
                    if (km.pace < bestPace.pace) {
                        bestPace = {
                            pace: km.pace,
                            formattedPace: km.formattedPace,
                            km: km.km,
                            session: session
                        };
                    }
                }
            }
            const totalPaceForAll = sessions.reduce((sum, session) => {
                const paceForAll = session.kilometers
                    .reduce((kmSum, km) => kmSum + km.pace, 0) / 10;
                return sum + paceForAll;
            }, 0);
            const overallAvgPace = totalPaceForAll / sessions.length;
            let bestSegment = {
                startKm: 0,
                avgPace: Infinity,
                session: null
            };
            for (const session of sessions) {
                for (let i = 0; i <= session.kilometers.length - 3; i++) {
                    const segment = session.kilometers.slice(i, i + 3);
                    const segmentAvgPace = segment.reduce((sum, km) => sum + km.pace, 0) / 3;
                    if (segmentAvgPace < bestSegment.avgPace) {
                        bestSegment = {
                            startKm: i + 1,
                            endKm: i + 3,
                            avgPace: segmentAvgPace,
                            formattedPace: formatPace(segmentAvgPace),
                            session: session
                        };
                    }
                }
            }
            let best5k = {
                time: Infinity,
                session: null
            };
            let best10k = {
                time: Infinity,
                session: null
            };
            for (const session of sessions) {
                if (session.kilometers.length >= 5) {
                    const time5k = session.kilometers.slice(0, 5).reduce((sum, km) => sum + km.time, 0);
                    if (time5k < best5k.time) {
                        best5k = {
                            time: time5k,
                            session: session
                        };
                    }
                }
                const time10k = session.kilometers.reduce((sum, km) => sum + km.time, 0);
                if (time10k < best10k.time) {
                    best10k = {
                        time: time10k,
                        session: session
                    };
                }
            }
            const lastSession = sessions[sessions.length - 1];
            const altitudeData = lastSession.altitudeData;
            updateStatsDisplay(bestPace, overallAvgPace, bestSegment);
            updatePrDisplay(best5k, best10k);
            updateSessionsTable(altitudeData);
        }
        function updateStatsDisplay(bestPace, overallAvgPace, bestSegment) {
            bestPaceElement.textContent = bestPace.formattedPace;
            bestPaceDetailsElement.textContent = `Date: ${bestPace.session.formattedDate}, Kilometer: ${bestPace.km}`;
            avgPaceElement.textContent = formatPace(overallAvgPace);
            bestSegmentElement.textContent = `km ${bestSegment.startKm}-${bestSegment.endKm}`;
            bestSegmentDetailsElement.textContent = `Average pace: ${bestSegment.formattedPace}`;
        }
        function updatePrDisplay(best5k, best10k) {
            if (best5k.session && best10k.session) {
                prSection.style.display = 'block';
                best5kElement.textContent = formatTime(best5k.time);
                best5kDateElement.textContent = `Date: ${best5k.session.formattedDate}`;
                best10kElement.textContent = formatTime(best10k.time);
                best10kDateElement.textContent = `Date: ${best10k.session.formattedDate}`;
            }
        }
        const table = document.getElementById('sessions-table');
        const observer = new ResizeObserver(entries => {
            adjustGraphWidth();
        });
        observer.observe(table);
        function updateSessionsTable(altitudeData) {
            sessionsTableBody.innerHTML = '';
            const absoluteBestPaces = Array(10).fill(Infinity);
            for (const session of sessions) {
                for (let i = 0; i < 10 && i < session.kilometers.length; i++) {
                    if (session.kilometers[i].pace < absoluteBestPaces[i]) {
                        absoluteBestPaces[i] = session.kilometers[i].pace;
                    }
                }
            }
            const personalBestPaces = Array(10).fill(Infinity);
            updateAltitudeGraph(altitudeData);
            for (let s = 0; s < sessions.length; s++) {
                const session = sessions[s];
                const row = document.createElement('tr');
                const dateCell = document.createElement('td');
                dateCell.textContent = session.formattedDate;
                row.appendChild(dateCell);
                const avgPaceCell = document.createElement('td');
                avgPaceCell.textContent = session.formattedAvgPace;
                if (s > 0) {
                    const prevAvg = sessions[s - 1].avgPace;
                    if (session.avgPace < prevAvg) {
                        avgPaceCell.classList.add('improved');
                    } else if (session.avgPace > prevAvg) {
                        avgPaceCell.classList.add('worse');
                    } else {
                        avgPaceCell.classList.add('unchanged');
                    }
                }
                row.appendChild(avgPaceCell);
                for (let i = 0; i < 10 && i < session.kilometers.length; i++) {
                    const km = session.kilometers[i];
                    const kmCell = document.createElement('td');
                    kmCell.textContent = km.formattedPace;
                    if (km.pace === absoluteBestPaces[i]) {
                        kmCell.classList.add('best-ever');
                    }
                    if (km.pace < personalBestPaces[i]) {
                        kmCell.classList.add('best-current');
                        personalBestPaces[i] = km.pace;
                    }
                    if (s > 0 && sessions[s - 1].kilometers[i]) {
                        const prevKmPace = sessions[s - 1].kilometers[i].pace;
                        if (km.pace < prevKmPace) {
                            kmCell.classList.add('improved');
                        } else if (km.pace > prevKmPace) {
                            kmCell.classList.add('worse');
                        } else {
                            kmCell.classList.add('unchanged');
                        }
                    }
                    if (km.pace < 5.0) {
                        kmCell.classList.add('pace-zone1');
                    } else if (km.pace < 5.5) {
                        kmCell.classList.add('pace-zone2');
                    } else if (km.pace < 6.0) {
                        kmCell.classList.add('pace-zone3');
                    } else if (km.pace < 6.5) {
                        kmCell.classList.add('pace-zone4');
                    } else {
                        kmCell.classList.add('pace-zone5');
                    }
                    if (s === sessions.length - 1) {
                        const lastFiveSessions = sessions.slice(Math.max(0, sessions.length - 5));
                        const lastFivePaces = lastFiveSessions
                            .filter(s => s.kilometers[i])
                            .map(s => s.kilometers[i].pace);
                        if (lastFivePaces.length >= 2) {
                            const currentPace = km.pace;
                            const worstPace = Math.max(...lastFivePaces);
                            const avgPace = lastFivePaces.reduce((sum, p) => sum + p, 0) / lastFivePaces.length;
                            const evaluation = document.createElement('span');
                            evaluation.className = 'evaluation-text';
                            if (currentPace === worstPace) {
                                evaluation.textContent = 'Worse';
                                evaluation.classList.add('evaluation-bad');
                            } else if (currentPace <= avgPace) {
                                evaluation.textContent = 'Better';
                                evaluation.classList.add('evaluation-better');
                            } else {
                                const paceDifference = Math.abs(currentPace - avgPace);
                                if (paceDifference / avgPace <= 0.05) {
                                    evaluation.textContent = 'Good';
                                    evaluation.classList.add('evaluation-good');
                                } else {
                                    evaluation.textContent = 'Worse';
                                    evaluation.classList.add('evaluation-bad');
                                }
                            }
                            kmCell.appendChild(document.createElement('br'));
                            kmCell.appendChild(evaluation);
                        }
                    }
                    row.appendChild(kmCell);
                }
                sessionsTableBody.appendChild(row);
            }
            setTimeout(() => {
                adjustGraphWidth();
            }, 1000);
        }
        function updateAltitudeGraph(altitudeData) {
            if (!altitudeData || altitudeData.length === 0) return;
            const graph = document.getElementById('altitude-graph');
            graph.innerHTML = '';
            graph.setAttribute('viewBox', '0 0 1000 80');
            if (!graph.querySelector('defs')) {
                const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
                gradient.setAttribute('id', 'altitude-gradient');
                gradient.setAttribute('x1', '0%');
                gradient.setAttribute('y1', '0%');
                gradient.setAttribute('x2', '0%');
                gradient.setAttribute('y2', '100%');
                const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                stop1.setAttribute('offset', '0%');
                stop1.setAttribute('stop-color', 'var(--accent)');
                stop1.setAttribute('stop-opacity', '0.3');
                const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                stop2.setAttribute('offset', '100%');
                stop2.setAttribute('stop-color', 'var(--accent)');
                stop2.setAttribute('stop-opacity', '0.1');
                gradient.appendChild(stop1);
                gradient.appendChild(stop2);
                defs.appendChild(gradient);
                graph.appendChild(defs);
            }
            const minAltitude = Math.min(...altitudeData.map(d => d.elevation));
            const maxAltitude = Math.max(...altitudeData.map(d => d.elevation));
            const altitudeRange = maxAltitude - minAltitude || 1;
            const points = altitudeData.map(data => {
                const x = (data.distance / 10000) * 1000;
                const y = 80 - ((data.elevation - minAltitude) / altitudeRange) * 75;
                return `${x},${y}`;
            }).join(' ');
            const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            polyline.setAttribute('points', points);
            polyline.setAttribute('stroke', 'var(--accent)');
            polyline.setAttribute('stroke-width', '2');
            polyline.setAttribute('fill', 'url(#altitude-gradient)');
            graph.appendChild(polyline);
            for (let km = 0; km <= 10; km++) {
                const lineX = km * 100;
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', lineX);
                line.setAttribute('y1', '0');
                line.setAttribute('x2', lineX);
                line.setAttribute('y2', '80');
                line.setAttribute('stroke', 'rgba(255, 255, 255, 0.3)');
                line.setAttribute('stroke-width', '1');
                line.setAttribute('stroke-dasharray', '2,2');
                graph.appendChild(line);
                if (km > 0 && km <= 10) {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', lineX - 5);
                    text.setAttribute('y', '75');
                    text.setAttribute('fill', 'var(--text-secondary)');
                    text.setAttribute('font-size', '10');
                    text.setAttribute('font-weight', 'bold');
                    text.textContent = km;
                    graph.appendChild(text);
                }
            }
            const avgAltitudeChanges = sessions.reduce((acc, session) => {
                session.kilometers.forEach((km, index) => {
                    if (!acc[index]) acc[index] = [];
                    acc[index].push(km.altitudeChange);
                });
                return acc;
            }, []).map(changes => {
                const sum = changes.reduce((acc, val) => acc + val, 0);
                return (sum / changes.length).toFixed(1);
            });
            const altitudeValues = document.getElementById('altitude-values');
            altitudeValues.innerHTML = '';
            avgAltitudeChanges.forEach((change, index) => {
                const formattedChange = parseFloat(change) >= 0 ? `+${change}` : `${change}`;
                const th = document.createElement('th');
                th.textContent = formattedChange;
                altitudeValues.appendChild(th);
            });
            adjustGraphWidth();
        }
        function adjustGraphWidth() {
            const table = document.getElementById('altitude-header');
            const firstKmCell = table.querySelector('th:nth-child(2)');
            if (firstKmCell) {
                const graphContainer = document.getElementById('altitude-graph-container');
                const kmColumnsWidth = firstKmCell.getBoundingClientRect().width;
                graphContainer.style.width = `${kmColumnsWidth}px`;
                console.log('kmColumnsWidth = ' + kmColumnsWidth);
                console.log('firstKmCell.width = ' + firstKmCell.getBoundingClientRect().width);
                console.log('graphContainer.style.width = ' + graphContainer.style.width);
            }
        }
        function exportToCsv() {
            if (sessions.length === 0) return;
            let csv = 'Date,Avg Pace (min/km)';
            for (let i = 1; i <= 10; i++) {
                csv += `,Km ${i} Pace`;
            }
            csv += ',Elevation Gain (m)\n';
            for (const session of sessions) {
                csv += `"${session.formattedDate}",${session.formattedAvgPace}`;
                for (const km of session.kilometers) {
                    csv += `,${km.formattedPace}`;
                }
                csv += `,${session.elevationGain}\n`;
            }
            const blob = new Blob([csv], {
                type: 'text/csv;charset=utf-8;'
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'running-analysis.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        // ADDED: All new functions for map visualization and interaction
        function initializeInteractiveMap(trackpoints, overallAvgPace) {
            console.log('Initializing interactive map...');
            mapCard.style.display = 'block';
            if (currentMap) {
                console.log('Removing existing map instance.');
                currentMap.remove();
                currentMap = null;
                distanceMarker = null;
            }
            // MODIFIED: Pre-process trackpoints for smoothed gradient and pace
            preprocessTrackpoints(trackpoints, 50, 15, overallAvgPace);
            displayMapAndTrack(trackpoints);
            const totalDistanceKm = trackpoints[trackpoints.length - 1].distance / 1000;
            distanceSlider.max = totalDistanceKm.toFixed(2);
            distanceSlider.value = 0;
            updateMapInteraction(0);
        }
        /**
         * MODIFIED: Pre-calculates rolling gradient and pace for each trackpoint.
         * This smooths the data for a better visual representation.
         * @param {Array} trackpoints The array of trackpoint objects.
         * @param {number} gradientWindowMeters The distance window for averaging gradient.
         * @param {number} paceWindowSeconds The time window for averaging pace.
         * @param {number} fallbackPace The overall average pace for the run.
         */
        function preprocessTrackpoints(trackpoints, gradientWindowMeters, paceWindowSeconds, fallbackPace) {
            if (trackpoints.length === 0) return;
            let gradPtr = 0; // Pointer for the start of the gradient window
            let pacePtr = 0; // Pointer for the start of the pace window
            for (let i = 0; i < trackpoints.length; i++) {
                // Advance the gradient window pointer
                while (trackpoints[i].distance - trackpoints[gradPtr].distance > gradientWindowMeters) {
                    gradPtr++;
                }
                // Advance the pace window pointer
                while ((trackpoints[i].time - trackpoints[pacePtr].time) / 1000 > paceWindowSeconds) {
                    pacePtr++;
                }
                // Calculate and assign smoothed gradient
                const gradDist = trackpoints[i].distance - trackpoints[gradPtr].distance;
                const gradAlt = trackpoints[i].altitude - trackpoints[gradPtr].altitude;
                trackpoints[i].avgGradient = (gradDist > 0) ? gradAlt / gradDist : 0;
                // Calculate and assign smoothed pace
                const paceDist = trackpoints[i].distance - trackpoints[pacePtr].distance;
                const paceTime = (trackpoints[i].time - trackpoints[pacePtr].time) / 1000;
                if (paceDist > 0 && paceTime > 0) {
                    trackpoints[i].avgPace = (paceTime / 60) / (paceDist / 1000);
                } else {
                    trackpoints[i].avgPace = fallbackPace; // Use overall average for the start
                }
            }
            console.log("Pre-processed trackpoints for smoothed gradient and pace.");
        }
        function displayMapAndTrack(trackpoints) {
            currentMap = L.map('map');
            const tileUrl = isDarkMode ?
                'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' :
                'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            L.tileLayer(tileUrl, {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(currentMap);
            for (let i = 1; i < trackpoints.length; i++) {
                const prevPoint = trackpoints[i - 1];
                const currentPoint = trackpoints[i];
                if (prevPoint.lat && prevPoint.lng && currentPoint.lat && currentPoint.lng) {
                    const segmentGradient = (prevPoint.avgGradient + currentPoint.avgGradient) / 2;
                    const color = getColorForGradient(segmentGradient);
                    L.polyline([
                        [prevPoint.lat, prevPoint.lng],
                        [currentPoint.lat, currentPoint.lng]
                    ], {
                        color: color,
                        weight: 4,
                        opacity: 0.85
                    }).addTo(currentMap);
                }
            }
            const bounds = L.latLngBounds(trackpoints.map(p => [p.lat, p.lng]));
            currentMap.fitBounds(bounds.pad(0.1));
            console.log(`Map initialized and track rendered with ${trackpoints.length} points.`);
        }
        function getColorForGradient(gradient) {
            const maxChallengeGradient = 0.08;
            const clampedGradient = Math.max(-maxChallengeGradient, Math.min(maxChallengeGradient, gradient));
            const normalized = (clampedGradient + maxChallengeGradient) / (maxChallengeGradient * 2);
            let r, g, b;
            if (normalized < 0.5) { // Downhill: Blue to Green
                const ratio = normalized * 2;
                r = 0;
                g = Math.round(255 * ratio);
                b = Math.round(255 * (1 - ratio));
            } else { // Uphill: Green to Red
                const ratio = (normalized - 0.5) * 2;
                r = Math.round(255 * ratio);
                g = Math.round(255 * (1 - ratio));
                b = 0;
            }
            return `rgb(${r},${g},${b})`;
        }
        function updateMapInteraction(distanceKm) {
            const targetDistanceMeters = distanceKm * 1000;
            const {
                point,
                index
            } = findTrackpointByDistance(targetDistanceMeters);
            if (!point) return;
            // MODIFIED: Use pre-calculated smoothed pace
            livePaceEl.textContent = point.avgPace ? formatPace(point.avgPace) : '--:--';
            liveAltitudeEl.textContent = point.altitude ? `${point.altitude.toFixed(1)} m` : '-- m';
            liveHrEl.textContent = point.heartRate ? `${point.heartRate} BPM` : '-- BPM';
            const latLng = [point.lat, point.lng];
            if (!distanceMarker) {
                distanceMarker = L.circleMarker(latLng, {
                    radius: 8,
                    color: 'white',
                    weight: 2,
                    fillColor: 'var(--accent)',
                    fillOpacity: 1
                }).addTo(currentMap);
            } else {
                distanceMarker.setLatLng(latLng);
            }
        }
        function findTrackpointByDistance(targetDistanceMeters) {
            if (lastRunTrackpoints.length === 0) return {
                point: null,
                index: -1
            };
            let closestPoint = lastRunTrackpoints[0];
            let closestIndex = 0;
            let minDiff = Math.abs(closestPoint.distance - targetDistanceMeters);
            for (let i = 1; i < lastRunTrackpoints.length; i++) {
                const point = lastRunTrackpoints[i];
                const diff = Math.abs(point.distance - targetDistanceMeters);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestPoint = point;
                    closestIndex = i;
                }
            }
            return {
                point: closestPoint,
                index: closestIndex
            };
        }
        // Helper Functions
        function formatDate(date) {
            return date.toLocaleDateString(undefined, {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        function formatPace(paceInMinutes) {
            const minutes = Math.floor(paceInMinutes);
            const seconds = Math.round((paceInMinutes - minutes) * 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
